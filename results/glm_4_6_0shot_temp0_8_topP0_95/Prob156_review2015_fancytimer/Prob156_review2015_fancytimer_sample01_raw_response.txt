
module TopModule (
  input wire clk,
  input wire reset,
  input wire data,
  output wire [3:0] count,
  output reg counting,
  output reg done,
  input wire ack
);
  
  // State definitions
  parameter IDLE = 2'b00;
  parameter SHIFT_DELAY = 2'b01;
  parameter COUNTING = 2'b10;
  parameter DONE = 2'b11;
  
  reg [1:0] state, next_state;
  
  // Pattern detection shift register
  reg [3:0] pattern_reg;
  
  // Delay value storage
  reg [3:0] delay_reg;
  reg [3:0] delay_count;
  
  // 1000-cycle counter
  reg [9:0] cycle_counter;
  
  // Count output
  reg [3:0] count_reg;
  
  // State machine transitions
  always @(posedge clk) begin
    if (reset) begin
      state <= IDLE;
    end else begin
      state <= next_state;
    end
  end
  
  // Next state logic
  always @(*) begin
    next_state = state;
    case (state)
      IDLE: begin
        if (pattern_reg == 4'b1101) begin
          next_state = SHIFT_DELAY;
        end
      end
      SHIFT_DELAY: begin
        if (delay_count == 4) begin
          next_state = COUNTING;
        end
      end
      COUNTING: begin
        if (delay_count == 4'b1111 && cycle_counter == 999) begin
          next_state = DONE;
        end
      end
      DONE: begin
        if (ack) begin
          next_state = IDLE;
        end
      end
    endcase
  end
  
  // Output logic and